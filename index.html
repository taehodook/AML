<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPAC ìê¸ˆì„¸íƒë°©ì§€ í€´ì¦ˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a;
      --bg2: #111827;
      --bg3: #1e2535;
      --accent: #00d4ff;
      --accent2: #7c3aed;
      --accent3: #f59e0b;
      --success: #10b981;
      --error: #ef4444;
      --text: #e2e8f0;
      --text2: #94a3b8;
      --border: #2d3748;
      --card-shadow: 0 4px 24px rgba(0,212,255,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(124,58,237,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(0,212,255,0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 1; }

    /* Header */
    header {
      background: rgba(17,24,39,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }
    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.5px;
    }
    .logo span { color: var(--accent2); }
    
    .header-nav { display: flex; gap: 8px; align-items: center; }
    .nav-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: 'Noto Sans KR', sans-serif;
      transition: all 0.2s;
    }
    .nav-btn:hover { border-color: var(--accent); color: var(--accent); }
    .nav-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    #user-badge {
      background: var(--bg3);
      border: 1px solid var(--border);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.82rem;
      color: var(--accent3);
      display: none;
    }

    /* Screen management */
    .screen { display: none; padding: 40px 0; }
    .screen.active { display: block; }

    /* Cards */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--card-shadow);
    }

    /* Titles */
    h1 { font-size: 2.2rem; font-weight: 900; line-height: 1.2; margin-bottom: 8px; }
    h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 16px; }
    h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; }
    .subtitle { color: var(--text2); font-size: 1rem; margin-bottom: 32px; }
    .gradient-text {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'Noto Sans KR', sans-serif;
      text-decoration: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      color: var(--bg);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,212,255,0.3); }
    .btn-secondary {
      background: var(--bg3);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { border-color: var(--accent); }
    .btn-danger { background: var(--error); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-purple { background: linear-gradient(135deg, var(--accent2), #9333ea); color: white; }
    .btn-purple:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(124,58,237,0.3); }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .btn-block { width: 100%; }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text2); margin-bottom: 8px; }
    input, select, textarea {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-family: 'Noto Sans KR', sans-serif;
      transition: border-color 0.2s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg3);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text2);
      transition: all 0.2s;
    }
    .tab.active { background: var(--accent); color: var(--bg); font-weight: 700; }

    /* Landing Screen */
    .hero { text-align: center; padding: 80px 0 60px; }
    .badge {
      display: inline-block;
      background: rgba(0,212,255,0.1);
      border: 1px solid rgba(0,212,255,0.3);
      color: var(--accent);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 24px;
      font-family: 'Space Mono', monospace;
    }
    .hero-buttons { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-top: 40px; }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 40px;
    }
    .feature-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      transition: border-color 0.2s;
    }
    .feature-card:hover { border-color: var(--accent); }
    .feature-icon { font-size: 2rem; margin-bottom: 12px; }
    .feature-card h3 { font-size: 1rem; margin-bottom: 8px; }
    .feature-card p { color: var(--text2); font-size: 0.875rem; line-height: 1.6; }

    /* Login/Register */
    .auth-card { max-width: 480px; margin: 0 auto; }

    /* Quiz Screen */
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .quiz-meta {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .quiz-num {
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
      color: var(--accent);
      background: rgba(0,212,255,0.1);
      padding: 4px 12px;
      border-radius: 8px;
    }
    .timer {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .timer-ring-wrap {
      position: relative;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }
    .timer-ring-wrap svg { transform: rotate(-90deg); }
    .timer-ring-bg { fill: none; stroke: var(--bg3); stroke-width: 4; }
    .timer-ring-fill {
      fill: none;
      stroke: var(--accent3);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 126;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear, stroke 0.3s;
    }
    .timer-ring-fill.danger { stroke: var(--error); }
    .timer-num {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--accent3);
    }
    .timer-num.danger { color: var(--error); }
    .timer-label {
      font-size: 0.78rem;
      color: var(--text2);
      line-height: 1.3;
    }
    .timer-label strong {
      display: block;
      font-size: 0.9rem;
      color: var(--accent3);
      font-family: 'Space Mono', monospace;
    }
    .timer-label strong.danger { color: var(--error); }

    /* Timeout flash overlay */
    @keyframes flashRed {
      0%   { background: rgba(239,68,68,0.0); }
      30%  { background: rgba(239,68,68,0.18); }
      100% { background: rgba(239,68,68,0.0); }
    }
    .timeout-flash { animation: flashRed 0.6s ease; }

    /* Shake animation for timeout */
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-6px); }
      40%     { transform: translateX(6px); }
      60%     { transform: translateX(-4px); }
      80%     { transform: translateX(4px); }
    }
    .shake { animation: shake 0.4s ease; }
    
    .progress-bar {
      height: 4px;
      background: var(--bg3);
      border-radius: 2px;
      margin-bottom: 32px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .question-text {
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.7;
      margin-bottom: 28px;
      white-space: pre-wrap;
    }

    .options-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }
    .option-btn {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 20px;
      background: var(--bg3);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--text);
      text-align: left;
      transition: all 0.2s;
      line-height: 1.5;
    }
    .option-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(0,212,255,0.05); }
    .option-btn.selected { border-color: var(--accent); background: rgba(0,212,255,0.1); }
    .option-btn.correct { border-color: var(--success); background: rgba(16,185,129,0.1); color: var(--success); }
    .option-btn.wrong { border-color: var(--error); background: rgba(239,68,68,0.1); color: var(--error); }
    .option-btn.reveal { border-color: var(--success); background: rgba(16,185,129,0.05); }
    .option-btn:disabled { cursor: not-allowed; }
    .option-num {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      background: var(--bg2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
    }

    .explanation-box {
      background: rgba(16,185,129,0.08);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    .explanation-box.show { display: block; }
    .explanation-box h4 { color: var(--success); margin-bottom: 8px; font-size: 0.9rem; }
    .explanation-box p { color: var(--text); font-size: 0.9rem; line-height: 1.6; }
    .explanation-source { color: var(--text2); font-size: 0.8rem; margin-top: 8px; }

    .quiz-actions { display: flex; gap: 12px; justify-content: flex-end; }

    /* Results Screen */
    .score-hero { text-align: center; padding: 40px 0; }
    .score-circle {
      width: 160px;
      height: 160px;
      margin: 0 auto 24px;
      position: relative;
    }
    .score-circle svg { transform: rotate(-90deg); }
    .score-circle .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .score-number { font-size: 2.5rem; font-weight: 900; color: var(--accent); font-family: 'Space Mono', monospace; }
    .score-total { font-size: 0.9rem; color: var(--text2); }
    .score-grade { font-size: 1.2rem; font-weight: 700; }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 32px 0;
    }
    .stat-card {
      background: var(--bg3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 1.8rem; font-weight: 900; font-family: 'Space Mono', monospace; }
    .stat-label { font-size: 0.8rem; color: var(--text2); margin-top: 4px; }

    .wrong-list { margin-top: 32px; }
    .wrong-item {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
    }
    .wrong-item-num { 
      font-size: 0.75rem; 
      color: var(--text2); 
      font-family: 'Space Mono', monospace; 
      margin-bottom: 8px;
    }
    .wrong-item-q { font-size: 0.9rem; margin-bottom: 12px; line-height: 1.5; white-space: pre-wrap; }
    .wrong-answer-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; }
    .answer-badge {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 700;
    }
    .answer-badge.my-answer { background: rgba(239,68,68,0.15); color: var(--error); border: 1px solid rgba(239,68,68,0.3); }
    .answer-badge.correct-answer { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }
    .wrong-explain { font-size: 0.85rem; color: var(--text2); line-height: 1.6; }

    /* Ranking Screen */
    .ranking-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .ranking-table th {
      text-align: left;
      padding: 8px 16px;
      color: var(--text2);
      font-size: 0.8rem;
      font-weight: 500;
    }
    .ranking-table td {
      padding: 14px 16px;
      background: var(--bg2);
      font-size: 0.9rem;
    }
    .ranking-table td:first-child { border-radius: 10px 0 0 10px; }
    .ranking-table td:last-child { border-radius: 0 10px 10px 0; }
    .ranking-table tr:hover td { background: var(--bg3); }
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.85rem;
      font-family: 'Space Mono', monospace;
    }
    .rank-1 { background: rgba(245,158,11,0.2); color: var(--accent3); border: 1px solid var(--accent3); }
    .rank-2 { background: rgba(148,163,184,0.2); color: #94a3b8; border: 1px solid #94a3b8; }
    .rank-3 { background: rgba(205,133,63,0.2); color: #cd853f; border: 1px solid #cd853f; }
    .rank-other { background: var(--bg3); color: var(--text2); border: 1px solid var(--border); }
    .my-row td { background: rgba(0,212,255,0.05) !important; }
    .my-row td:first-child { border-left: 3px solid var(--accent); border-radius: 10px 0 0 10px; }

    /* Admin Screen */
    .admin-tabs { margin-bottom: 24px; }
    .quiz-item-admin {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .quiz-item-content { flex: 1; }
    .quiz-item-num { font-size: 0.75rem; color: var(--accent); font-family: 'Space Mono', monospace; margin-bottom: 4px; }
    .quiz-item-q { font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; }
    .quiz-item-actions { display: flex; gap: 8px; flex-shrink: 0; }
    
    /* Upload area */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .upload-area:hover { border-color: var(--accent); background: rgba(0,212,255,0.02); }
    .upload-icon { font-size: 3rem; margin-bottom: 12px; }
    .upload-text { color: var(--text2); font-size: 0.9rem; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-close { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 1.5rem; }

    /* Alerts */
    .alert {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    .alert-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--error); }
    .alert-success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: var(--success); }
    .alert-info { background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); color: var(--accent); }

    /* Misc */
    .divider { height: 1px; background: var(--border); margin: 24px 0; }
    .text-center { text-align: center; }
    .text-sm { font-size: 0.875rem; }
    .text-muted { color: var(--text2); }
    .mt-4 { margin-top: 16px; }
    .mt-8 { margin-top: 32px; }
    .flex { display: flex; }
    .gap-2 { gap: 8px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .flex-wrap { flex-wrap: wrap; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }

    /* Quiz count selector */
    .count-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .count-option {
      flex: 1;
      min-width: 80px;
      padding: 12px;
      background: var(--bg3);
      border: 2px solid var(--border);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
      transition: all 0.2s;
    }
    .count-option:hover { border-color: var(--accent); }
    .count-option.selected { border-color: var(--accent); background: rgba(0,212,255,0.1); color: var(--accent); }
    .count-option .sub { font-size: 0.75rem; color: var(--text2); font-weight: 400; margin-top: 2px; }

    @media (max-width: 600px) {
      .result-stats { grid-template-columns: repeat(2, 1fr); }
      h1 { font-size: 1.7rem; }
      .feature-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">TPAC<span>.</span>quiz</div>
    <div class="header-nav">
      <div id="user-badge">ğŸ‘¤ <span id="user-name-badge"></span></div>
      <button class="nav-btn" id="nav-ranking" onclick="showScreen('ranking')" style="display:none">ğŸ† ë­í‚¹</button>
      <button class="nav-btn" id="nav-quiz" onclick="startQuizSetup()" style="display:none">ğŸ“ í€´ì¦ˆ</button>
      <button class="nav-btn" id="nav-admin" onclick="showScreen('admin')" style="display:none">âš™ï¸ ê´€ë¦¬ì</button>
      <button class="nav-btn" id="nav-logout" onclick="logout()" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<!-- ====== LANDING SCREEN ====== -->
<div id="screen-landing" class="screen active">
  <div class="container">
    <div class="hero">
      <div class="badge">TPAC Â· ìê¸ˆì„¸íƒë°©ì§€ì—…ë¬´ëŠ¥ë ¥</div>
      <h1><span class="gradient-text">AML/CFT</span><br>í€´ì¦ˆ íŠ¸ë ˆì´ë„ˆ</h1>
      <p class="subtitle">ìê¸ˆì„¸íƒë°©ì§€ ì „ë¬¸ê°€ ì‹œí—˜ ëŒ€ë¹„<br>ì‹¤ì „ ë¬¸ì œ í’€ì´ Â· ë­í‚¹ ê²½ìŸ Â· ì„±ì  ë¶„ì„</p>
      <div class="hero-buttons">
        <button class="btn btn-primary" onclick="showScreen('login')" style="font-size:1rem;padding:14px 36px;">ğŸš€ ì‹œì‘í•˜ê¸°</button>
        <button class="btn btn-secondary" onclick="showScreen('login'); switchTab('admin-login')" style="font-size:1rem;padding:14px 36px;">âš™ï¸ ê´€ë¦¬ì</button>
      </div>
    </div>
    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon">ğŸ“š</div>
        <h3>50ë¬¸ì œ ì‹¤ì „ í€´ì¦ˆ</h3>
        <p>TPAC ê³µì‹ êµì¬(ì œë„í¸, ì‹¤ë¬´í¸) ê¸°ë°˜ì˜ ì–‘ì§ˆì˜ ë¬¸ì œë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ†</div>
        <h3>ì‹¤ì‹œê°„ ë­í‚¹</h3>
        <p>íšŒì›ë“¤ì˜ ìµœì¢… ì ìˆ˜ë¥¼ ë¹„êµí•˜ê³  ì‹¤ë ¥ì„ ê²½ìŸí•´ë³´ì„¸ìš”.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ“Š</div>
        <h3>í‹€ë¦° ë¬¸ì œ ë¶„ì„</h3>
        <p>í€´ì¦ˆ ì™„ë£Œ í›„ í‹€ë¦° ë¬¸ì œì˜ ì •ë‹µê³¼ í•´ì„¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">âš™ï¸</div>
        <h3>ê´€ë¦¬ì í€´ì¦ˆ ì—…ë°ì´íŠ¸</h3>
        <p>ê´€ë¦¬ìëŠ” ìƒˆë¡œìš´ ë¬¸ì œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í€´ì¦ˆ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>
</div>

<!-- ====== LOGIN SCREEN ====== -->
<div id="screen-login" class="screen">
  <div class="container">
    <div class="auth-card">
      <div class="card">
        <h2>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
        <div class="tabs">
          <div class="tab active" id="tab-login" onclick="switchTab('login')">ë¡œê·¸ì¸</div>
          <div class="tab" id="tab-register" onclick="switchTab('register')">íšŒì›ê°€ì…</div>
          <div class="tab" id="tab-admin-login" onclick="switchTab('admin-login')">ê´€ë¦¬ì</div>
        </div>

        <!-- Login Form -->
        <div id="form-login">
          <div id="login-error" class="alert alert-error" style="display:none"></div>
          <div class="form-group">
            <label>ì•„ì´ë””</label>
            <input type="text" id="login-id" placeholder="ì•„ì´ë”” ì…ë ¥" onkeydown="if(event.key==='Enter')doLogin()">
          </div>
          <div class="form-group">
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter')doLogin()">
          </div>
          <button class="btn btn-primary btn-block" onclick="doLogin()">ë¡œê·¸ì¸</button>
          <p class="text-center text-sm text-muted mt-4">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="switchTab('register')" style="color:var(--accent)">íšŒì›ê°€ì…</a></p>
        </div>

        <!-- Register Form -->
        <div id="form-register" style="display:none">
          <div id="register-error" class="alert alert-error" style="display:none"></div>
          <div id="register-success" class="alert alert-success" style="display:none">íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
          <div class="form-group">
            <label>ì•„ì´ë””</label>
            <input type="text" id="reg-id" placeholder="ì˜ë¬¸+ìˆ«ì, 4~12ì">
          </div>
          <div class="form-group">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" id="reg-nick" placeholder="í‘œì‹œë  ì´ë¦„">
          </div>
          <div class="form-group">
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="reg-pw" placeholder="6ì ì´ìƒ">
          </div>
          <div class="form-group">
            <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="reg-pw2" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" onkeydown="if(event.key==='Enter')doRegister()">
          </div>
          <button class="btn btn-primary btn-block" onclick="doRegister()">íšŒì›ê°€ì…</button>
          <p class="text-center text-sm text-muted mt-4">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" onclick="switchTab('login')" style="color:var(--accent)">ë¡œê·¸ì¸</a></p>
        </div>

        <!-- Admin Login -->
        <div id="form-admin-login" style="display:none">
          <div id="admin-error" class="alert alert-error" style="display:none"></div>
          <div class="form-group">
            <label>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="admin-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter')doAdminLogin()">
          </div>
          <button class="btn btn-purple btn-block" onclick="doAdminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
        </div>

        <div class="divider"></div>
        <button class="btn btn-secondary btn-block btn-sm" onclick="showScreen('landing')">â† ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== QUIZ SETUP SCREEN ====== -->
<div id="screen-quiz-setup" class="screen">
  <div class="container">
    <div class="card">
      <h2>ğŸ“ í€´ì¦ˆ ì„¤ì •</h2>
      <div class="alert alert-info" style="margin-bottom:20px">â± ë¬¸ì œë‹¹ <strong>1ë¶„(60ì´ˆ)</strong> ì œí•œì´ ìˆìŠµë‹ˆë‹¤. ì‹œê°„ ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ í‹€ë¦° ì²˜ë¦¬ ë©ë‹ˆë‹¤.</div>
      <p class="text-muted mb-4">í’€ê³  ì‹¶ì€ ë¬¸ì œ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì „ì²´ <span id="total-quiz-count"></span>ë¬¸ì œ)</p>
      <div class="count-selector" id="count-selector">
        <div class="count-option selected" data-count="5" onclick="selectCount(this)">5<div class="sub">ë¹ ë¥¸ ì—°ìŠµ</div></div>
        <div class="count-option" data-count="10" onclick="selectCount(this)">10<div class="sub">ê¸°ë³¸ ì—°ìŠµ</div></div>
        <div class="count-option" data-count="20" onclick="selectCount(this)">20<div class="sub">ì‹¬í™” ì—°ìŠµ</div></div>
        <div class="count-option" data-count="all" onclick="selectCount(this)">ì „ì²´<div class="sub">ì‹¤ì „ ëŒ€ë¹„</div></div>
      </div>
      <div class="alert alert-info" style="margin-top:0;margin-bottom:20px">ğŸ”€ ë§¤ë²ˆ ì „ì²´ ë¬¸ì œ ì¤‘ ë¬´ì‘ìœ„ë¡œ ì¶œì œë©ë‹ˆë‹¤.</div>
      <div class="flex gap-2">
        <button class="btn btn-secondary" onclick="showScreen('landing')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="startQuiz()" style="flex:1">í€´ì¦ˆ ì‹œì‘!</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== QUIZ SCREEN ====== -->
<div id="screen-quiz" class="screen">
  <div class="container">
    <div class="quiz-header">
      <div class="quiz-meta">
        <span class="quiz-num" id="quiz-num"></span>
      </div>
      <div class="timer" id="quiz-timer-wrap">
        <div class="timer-ring-wrap">
          <svg width="48" height="48" viewBox="0 0 48 48">
            <circle class="timer-ring-bg" cx="24" cy="24" r="20"/>
            <circle class="timer-ring-fill" id="timer-ring" cx="24" cy="24" r="20"/>
          </svg>
          <div class="timer-num" id="timer-num">60</div>
        </div>
        <div class="timer-label">
          <strong id="timer-label-val">1:00</strong>
          ë‚¨ì€ì‹œê°„
        </div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="confirmQuit()">ê·¸ë§Œí•˜ê¸°</button>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="quiz-progress"></div>
    </div>
    <div class="card">
      <div class="question-text" id="question-text"></div>
      <div class="options-grid" id="options-grid"></div>
      <div class="explanation-box" id="explanation-box">
        <h4>âœ… í•´ì„¤</h4>
        <p id="explanation-text"></p>
        <p class="explanation-source" id="explanation-source"></p>
      </div>
      <div class="quiz-actions">
        <button class="btn btn-primary" id="btn-next" onclick="nextQuestion()" style="display:none">ë‹¤ìŒ ë¬¸ì œ â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== RESULTS SCREEN ====== -->
<div id="screen-results" class="screen">
  <div class="container">
    <div class="card">
      <div class="score-hero">
        <div class="score-circle">
          <svg width="160" height="160" viewBox="0 0 160 160">
            <circle cx="80" cy="80" r="70" fill="none" stroke="#1e2535" stroke-width="12"/>
            <circle cx="80" cy="80" r="70" fill="none" stroke="url(#scoreGrad)" stroke-width="12"
              stroke-linecap="round" stroke-dasharray="439.8" id="score-ring" stroke-dashoffset="439.8"/>
            <defs>
              <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#7c3aed"/>
                <stop offset="100%" stop-color="#00d4ff"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-text">
            <div class="score-number" id="final-score">0</div>
            <div class="score-total" id="final-total">/ 0ì </div>
          </div>
        </div>
        <div class="score-grade" id="score-grade"></div>
        <p class="text-muted mt-4" id="score-msg"></p>
      </div>

      <div class="result-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-correct" style="color:var(--success)">0</div>
          <div class="stat-label">ì •ë‹µ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-wrong" style="color:var(--error)">0</div>
          <div class="stat-label">ì˜¤ë‹µ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-timeout" style="color:var(--accent3)">0</div>
          <div class="stat-label">ì‹œê°„ì´ˆê³¼</div>
        </div>
        <div class="stat-card" style="grid-column: span 3">
          <div class="stat-value" id="stat-time" style="color:var(--accent);font-size:1.4rem">-</div>
          <div class="stat-label">ì´ ì†Œìš” ì‹œê°„</div>
        </div>
      </div>

      <div class="flex gap-2 justify-center flex-wrap">
        <button class="btn btn-primary" onclick="startQuizSetup()">ë‹¤ì‹œ í’€ê¸°</button>
        <button class="btn btn-secondary" onclick="showScreen('ranking')">ğŸ† ë­í‚¹ ë³´ê¸°</button>
      </div>

      <div class="wrong-list" id="wrong-list">
        <div class="divider"></div>
        <h3>âŒ í‹€ë¦° ë¬¸ì œ í•´ì„¤</h3>
        <div id="wrong-items"></div>
      </div>
    </div>
  </div>
</div>

<!-- ====== RANKING SCREEN ====== -->
<div id="screen-ranking" class="screen">
  <div class="container">
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2>ğŸ† ë­í‚¹</h2>
        <button class="btn btn-secondary btn-sm" onclick="loadRankings()">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="alert alert-info">ì „ì²´ í€´ì¦ˆ ê¸°ì¤€ ìµœê³  ì ìˆ˜ê°€ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div id="ranking-content">
        <table class="ranking-table">
          <thead>
            <tr>
              <th>ìˆœìœ„</th>
              <th>ë‹‰ë„¤ì„</th>
              <th>ìµœê³  ì ìˆ˜</th>
              <th>ì •ë‹µë¥ </th>
              <th>ë„ì „ íšŸìˆ˜</th>
            </tr>
          </thead>
          <tbody id="ranking-tbody"></tbody>
        </table>
        <p id="no-ranking" class="text-center text-muted mt-8" style="display:none">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>
</div>

<!-- ====== ADMIN SCREEN ====== -->
<div id="screen-admin" class="screen">
  <div class="container">
    <div class="card">
      <h2>âš™ï¸ ê´€ë¦¬ì íŒ¨ë„</h2>
      <div class="tabs admin-tabs">
        <div class="tab active" id="atab-quiz" onclick="switchAdminTab('quiz')">ë¬¸ì œ ê´€ë¦¬</div>
        <div class="tab" id="atab-upload" onclick="switchAdminTab('upload')">ë¬¸ì œ ì—…ë¡œë“œ</div>
        <div class="tab" id="atab-members" onclick="switchAdminTab('members')">íšŒì› ê´€ë¦¬</div>
      </div>

      <!-- Quiz Management -->
      <div id="admin-quiz">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
          <span class="text-muted text-sm">ì „ì²´ <strong id="admin-q-count">0</strong>ë¬¸ì œ</span>
          <button class="btn btn-primary btn-sm" onclick="openAddQuizModal()">+ ë¬¸ì œ ì¶”ê°€</button>
        </div>
        <div id="admin-quiz-list"></div>
      </div>

      <!-- Upload -->
      <div id="admin-upload" style="display:none">
        <div class="alert alert-info">JSON í˜•ì‹ì˜ í€´ì¦ˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div class="upload-area" onclick="document.getElementById('quiz-file-input').click()">
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-text">JSON íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ<br><small>ë˜ëŠ” ì•„ë˜ì— ì§ì ‘ ì…ë ¥</small></div>
          <input type="file" id="quiz-file-input" accept=".json" style="display:none" onchange="handleFileUpload(event)">
        </div>
        <div class="form-group">
          <label>JSON ì§ì ‘ ì…ë ¥</label>
          <textarea id="json-paste" rows="10" placeholder='[{"id":1,"question":"ë¬¸ì œ ë‚´ìš©","options":["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"],"answer":0,"explanation":"í•´ì„¤","source":"ì¶œì²˜"}]'></textarea>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-secondary" onclick="previewJson()">ë¯¸ë¦¬ë³´ê¸°</button>
          <button class="btn btn-primary" onclick="applyJson()">ì ìš©í•˜ê¸°</button>
        </div>
        <div id="upload-result" class="mt-4"></div>
      </div>

      <!-- Members -->
      <div id="admin-members" style="display:none">
        <div id="members-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ====== QUIZ EDIT MODAL ====== -->
<div class="modal-overlay" id="modal-quiz">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-quiz-title">ë¬¸ì œ ì¶”ê°€/í¸ì§‘</h3>
      <button class="modal-close" onclick="closeModal('modal-quiz')">âœ•</button>
    </div>
    <div class="form-group">
      <label>ë¬¸ì œ</label>
      <textarea id="modal-q" rows="4"></textarea>
    </div>
    <div id="modal-options">
      <label>ì„ íƒì§€</label>
      <div class="form-group" style="margin-bottom:8px" id="opt-0"><input type="text" placeholder="â‘  ì„ íƒì§€"></div>
      <div class="form-group" style="margin-bottom:8px" id="opt-1"><input type="text" placeholder="â‘¡ ì„ íƒì§€"></div>
      <div class="form-group" style="margin-bottom:8px" id="opt-2"><input type="text" placeholder="â‘¢ ì„ íƒì§€"></div>
      <div class="form-group" style="margin-bottom:8px" id="opt-3"><input type="text" placeholder="â‘£ ì„ íƒì§€"></div>
      <div class="form-group" style="margin-bottom:16px" id="opt-4"><input type="text" placeholder="â‘¤ ì„ íƒì§€"></div>
    </div>
    <div class="form-group">
      <label>ì •ë‹µ ë²ˆí˜¸ (0ë¶€í„° ì‹œì‘, ì˜ˆ: â‘ =0, â‘¡=1)</label>
      <input type="number" id="modal-answer" min="0" max="4" value="0">
    </div>
    <div class="form-group">
      <label>í•´ì„¤</label>
      <textarea id="modal-explain" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label>ì¶œì²˜</label>
      <input type="text" id="modal-source">
    </div>
    <div class="flex gap-2 justify-center">
      <button class="btn btn-secondary" onclick="closeModal('modal-quiz')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveQuiz()">ì €ì¥</button>
    </div>
  </div>
</div>

<script src="quizdata.js"></script>
<script>
// ============ STATE ============
let state = {
  currentUser: null,
  isAdmin: false,
  quizQuestions: [],
  currentIndex: 0,
  answers: [],
  startTime: null,
  totalTimerInterval: null,
  questionTimerInterval: null,
  questionTimeLeft: 60,
  questionAnswered: false,
  selectedCount: 5,
  editingQuizId: null,
  currentScreen: 'landing'
};

// ============ DATA MANAGEMENT ============
function getUsers() {
  return JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '{}');
}
function saveUsers(users) {
  localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
}
function getRankings() {
  return JSON.parse(localStorage.getItem(STORAGE_KEYS.RANKINGS) || '[]');
}
function saveRankings(r) {
  localStorage.setItem(STORAGE_KEYS.RANKINGS, JSON.stringify(r));
}
function getQuizData() {
  const stored = localStorage.getItem(STORAGE_KEYS.QUIZ_DATA);
  return stored ? JSON.parse(stored) : QUIZ_DATA;
}
function saveQuizData(data) {
  localStorage.setItem(STORAGE_KEYS.QUIZ_DATA, JSON.stringify(data));
}

// ============ AUTH ============
async function doLogin() {
  const id = document.getElementById('login-id').value.trim();
  const pw = document.getElementById('login-pw').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  
  if (!id || !pw) { showErr(errEl, 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  
  const users = getUsers();
  const user = users[id];
  if (!user) { showErr(errEl, 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }
  
  const hash = await simpleHash(pw);
  if (user.pwHash !== hash) { showErr(errEl, 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  
  state.currentUser = { id, nickname: user.nickname };
  state.isAdmin = false;
  onLoginSuccess();
}

async function doRegister() {
  const id = document.getElementById('reg-id').value.trim();
  const nick = document.getElementById('reg-nick').value.trim();
  const pw = document.getElementById('reg-pw').value;
  const pw2 = document.getElementById('reg-pw2').value;
  const errEl = document.getElementById('register-error');
  const sucEl = document.getElementById('register-success');
  errEl.style.display = 'none'; sucEl.style.display = 'none';
  
  if (!id || !nick || !pw) { showErr(errEl, 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (!/^[a-zA-Z0-9]{4,12}$/.test(id)) { showErr(errEl, 'ì•„ì´ë””ëŠ” ì˜ë¬¸+ìˆ«ì 4~12ìì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
  if (pw.length < 6) { showErr(errEl, 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
  if (pw !== pw2) { showErr(errEl, 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  
  const users = getUsers();
  if (users[id]) { showErr(errEl, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }
  
  const hash = await simpleHash(pw);
  users[id] = { nickname: nick, pwHash: hash, joinDate: new Date().toISOString(), attempts: 0 };
  saveUsers(users);
  
  sucEl.style.display = 'block';
  setTimeout(() => { switchTab('login'); document.getElementById('login-id').value = id; }, 1500);
}

async function doAdminLogin() {
  const pw = document.getElementById('admin-pw').value;
  const errEl = document.getElementById('admin-error');
  errEl.style.display = 'none';
  
  // Admin password: "tpac@admin2024"
  const hash = await simpleHash(pw);
  const ADMIN_HASH = await simpleHash('tpac@admin2024');
  if (hash !== ADMIN_HASH) {
    showErr(errEl, 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return;
  }
  
  state.currentUser = { id: 'admin', nickname: 'ê´€ë¦¬ì' };
  state.isAdmin = true;
  onLoginSuccess();
  showScreen('admin');
}

function logout() {
  state.currentUser = null;
  state.isAdmin = false;
  updateHeader();
  showScreen('landing');
}

function onLoginSuccess() {
  updateHeader();
  if (!state.isAdmin) {
    showScreen('quiz-setup');
  } else {
    loadAdminQuizList();
  }
}

function updateHeader() {
  const loggedIn = !!state.currentUser;
  document.getElementById('user-badge').style.display = loggedIn ? 'block' : 'none';
  if (loggedIn) document.getElementById('user-name-badge').textContent = state.currentUser.nickname;
  document.getElementById('nav-ranking').style.display = loggedIn ? 'block' : 'none';
  document.getElementById('nav-quiz').style.display = (loggedIn && !state.isAdmin) ? 'block' : 'none';
  document.getElementById('nav-admin').style.display = state.isAdmin ? 'block' : 'none';
  document.getElementById('nav-logout').style.display = loggedIn ? 'block' : 'none';
}

// ============ SCREENS ============
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  state.currentScreen = name;
  if (name === 'ranking') loadRankings();
  if (name === 'admin') loadAdminQuizList();
  window.scrollTo(0, 0);
}

function switchTab(tab) {
  ['login','register','admin-login'].forEach(t => {
    document.getElementById(`tab-${t}`).classList.remove('active');
    document.getElementById(`form-${t}`).style.display = 'none';
  });
  document.getElementById(`tab-${tab}`).classList.add('active');
  document.getElementById(`form-${tab}`).style.display = 'block';
}

// ============ QUIZ SETUP ============
function startQuizSetup() {
  if (!state.currentUser) { showScreen('login'); return; }
  const total = getQuizData().length;
  document.getElementById('total-quiz-count').textContent = total;
  // Update "all" option
  const allOpt = document.querySelector('.count-option[data-count="all"]');
  if (allOpt) allOpt.innerHTML = `ì „ì²´<div class="sub">${total}ë¬¸ì œ</div>`;
  showScreen('quiz-setup');
}

function selectCount(el) {
  document.querySelectorAll('.count-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  state.selectedCount = el.dataset.count;
}

function startQuiz() {
  let questions = [...getQuizData()].sort(() => Math.random() - 0.5);
  
  const count = state.selectedCount === 'all' ? questions.length : Math.min(parseInt(state.selectedCount), questions.length);
  state.quizQuestions = questions.slice(0, count);
  state.currentIndex = 0;
  state.answers = [];
  state.startTime = Date.now();
  
  clearInterval(state.totalTimerInterval);
  clearInterval(state.questionTimerInterval);
  
  showScreen('quiz');
  renderQuestion();
}

// ============ QUIZ LOGIC ============
const QUESTION_TIME = 60; // seconds per question

function renderQuestion() {
  const q = state.quizQuestions[state.currentIndex];
  const total = state.quizQuestions.length;
  const current = state.currentIndex + 1;
  
  document.getElementById('quiz-num').textContent = `${current} / ${total}`;
  document.getElementById('quiz-progress').style.width = `${(current/total)*100}%`;
  document.getElementById('question-text').textContent = q.question;
  
  const grid = document.getElementById('options-grid');
  grid.innerHTML = '';
  const nums = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'];
  
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerHTML = `<span class="option-num">${nums[i]}</span><span>${opt}</span>`;
    btn.onclick = () => selectAnswer(i);
    grid.appendChild(btn);
  });
  
  document.getElementById('explanation-box').classList.remove('show');
  document.getElementById('btn-next').style.display = 'none';
  
  // Start per-question countdown
  startQuestionTimer();
}

function startQuestionTimer() {
  clearInterval(state.questionTimerInterval);
  state.questionTimeLeft = QUESTION_TIME;
  state.questionAnswered = false;
  updateTimerUI();
  
  state.questionTimerInterval = setInterval(() => {
    if (state.questionAnswered) return;
    state.questionTimeLeft--;
    updateTimerUI();
    
    if (state.questionTimeLeft <= 0) {
      clearInterval(state.questionTimerInterval);
      timeoutQuestion();
    }
  }, 1000);
}

function updateTimerUI() {
  const t = state.questionTimeLeft;
  const isDanger = t <= 10;
  const circumference = 126; // 2*Ï€*20
  const offset = circumference * (1 - t / QUESTION_TIME);
  
  const ring = document.getElementById('timer-ring');
  const numEl = document.getElementById('timer-num');
  const labelEl = document.getElementById('timer-label-val');
  
  ring.style.strokeDashoffset = offset;
  ring.className = 'timer-ring-fill' + (isDanger ? ' danger' : '');
  numEl.textContent = t;
  numEl.className = 'timer-num' + (isDanger ? ' danger' : '');
  
  const m = Math.floor(t / 60);
  const s = (t % 60).toString().padStart(2, '0');
  labelEl.textContent = `${m}:${s}`;
  labelEl.className = isDanger ? 'danger' : '';
}

function timeoutQuestion() {
  const q = state.quizQuestions[state.currentIndex];
  state.questionAnswered = true;
  
  // Mark as wrong (timeout = selected index -1, a sentinel)
  state.answers.push({ questionId: q.id, selected: -1, correct: false, question: q, timeout: true });
  
  // Disable all buttons & reveal correct
  const btns = document.querySelectorAll('.option-btn');
  btns.forEach(b => { b.disabled = true; });
  btns[q.answer].classList.add('reveal');
  
  // Flash card red
  const card = document.querySelector('#screen-quiz .card');
  card.classList.add('timeout-flash');
  setTimeout(() => card.classList.remove('timeout-flash'), 700);
  
  // Show timeout explanation
  const explBox = document.getElementById('explanation-box');
  explBox.style.background = 'rgba(239,68,68,0.08)';
  explBox.style.borderColor = 'rgba(239,68,68,0.3)';
  explBox.querySelector('h4').style.color = 'var(--error)';
  explBox.querySelector('h4').textContent = 'â° ì‹œê°„ ì´ˆê³¼! í‹€ë¦° ê²ƒìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.';
  document.getElementById('explanation-text').textContent = q.explanation;
  document.getElementById('explanation-source').textContent = `ğŸ“– ì¶œì²˜: ${q.source}`;
  explBox.classList.add('show');
  
  document.getElementById('btn-next').style.display = 'block';
  
  // Set timer to 0
  state.questionTimeLeft = 0;
  updateTimerUI();
}

function selectAnswer(idx) {
  if (state.questionAnswered) return;
  clearInterval(state.questionTimerInterval);
  state.questionAnswered = true;
  
  const q = state.quizQuestions[state.currentIndex];
  const btns = document.querySelectorAll('.option-btn');
  btns.forEach(b => { b.disabled = true; });
  
  const isCorrect = idx === q.answer;
  state.answers.push({ questionId: q.id, selected: idx, correct: isCorrect, question: q });
  
  btns[idx].classList.add(isCorrect ? 'correct' : 'wrong');
  if (!isCorrect) {
    btns[q.answer].classList.add('reveal');
  }
  
  const explBox = document.getElementById('explanation-box');
  explBox.style.background = '';
  explBox.style.borderColor = '';
  explBox.querySelector('h4').style.color = '';
  explBox.querySelector('h4').textContent = 'âœ… í•´ì„¤';
  document.getElementById('explanation-text').textContent = q.explanation;
  document.getElementById('explanation-source').textContent = `ğŸ“– ì¶œì²˜: ${q.source}`;
  explBox.classList.add('show');
  
  document.getElementById('btn-next').style.display = 'block';
}

function nextQuestion() {
  clearInterval(state.questionTimerInterval);
  state.currentIndex++;
  if (state.currentIndex >= state.quizQuestions.length) {
    finishQuiz();
  } else {
    renderQuestion();
  }
}

function confirmQuit() {
  if (confirm('í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ê¹Œì§€ì˜ ê²°ê³¼ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.')) {
    clearInterval(state.questionTimerInterval);
    finishQuiz();
  }
}

function finishQuiz() {
  clearInterval(state.questionTimerInterval);
  clearInterval(state.totalTimerInterval);
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  
  const answered = state.answers;
  const correct = answered.filter(a => a.correct).length;
  const total = state.quizQuestions.length;
  const score = Math.round((correct / total) * 100);
  
  if (state.currentUser && !state.isAdmin && answered.length === total) {
    saveUserResult(score, correct, total);
  }
  
  showResults(score, correct, total, elapsed);
}

function saveUserResult(score, correct, total) {
  const rankings = getRankings();
  const users = getUsers();
  const userId = state.currentUser.id;
  
  // Update user attempts
  if (users[userId]) {
    users[userId].attempts = (users[userId].attempts || 0) + 1;
    saveUsers(users);
  }
  
  const existing = rankings.find(r => r.userId === userId);
  if (existing) {
    existing.attempts = (existing.attempts || 1) + 1;
    if (score > existing.score || (score === existing.score && correct > existing.correct)) {
      existing.score = score;
      existing.correct = correct;
      existing.total = total;
      existing.date = new Date().toISOString();
    }
  } else {
    rankings.push({
      userId,
      nickname: state.currentUser.nickname,
      score,
      correct,
      total,
      attempts: 1,
      date: new Date().toISOString()
    });
  }
  rankings.sort((a,b) => b.score - a.score || b.correct - a.correct);
  saveRankings(rankings);
}

function showResults(score, correct, total, elapsed) {
  // Score circle animation
  const ring = document.getElementById('score-ring');
  const circumference = 2 * Math.PI * 70;
  const offset = circumference - (score / 100) * circumference;
  setTimeout(() => { ring.style.strokeDashoffset = offset; ring.style.transition = 'stroke-dashoffset 1.5s ease'; }, 100);
  
  document.getElementById('final-score').textContent = score;
  document.getElementById('final-total').textContent = `/ 100ì `;
  document.getElementById('stat-correct').textContent = correct;
  document.getElementById('stat-wrong').textContent = (total - correct);
  document.getElementById('stat-timeout').textContent = state.answers.filter(a => a.timeout).length;
  
  const m = Math.floor(elapsed/60);
  const s = elapsed % 60;
  document.getElementById('stat-time').textContent = m > 0 ? `${m}ë¶„${s}ì´ˆ` : `${s}ì´ˆ`;
  
  let grade, msg;
  if (score >= 90) { grade = 'ğŸ¥‡ ìš°ìˆ˜'; msg = 'í›Œë¥­í•©ë‹ˆë‹¤! ì‹¤ì „ ì‹œí—˜ë„ ë¬¸ì œì—†ì–´ìš”!'; }
  else if (score >= 80) { grade = 'ğŸ¥ˆ ì–‘í˜¸'; msg = 'ì˜ í•˜ì…¨ì–´ìš”! ì¡°ê¸ˆë§Œ ë” ì—°ìŠµí•˜ë©´ ì™„ë²½í•´ìš”.'; }
  else if (score >= 70) { grade = 'ğŸ¥‰ ë³´í†µ'; msg = 'ê´œì°®ì€ ì„±ì ì´ì—ìš”. í‹€ë¦° ë¬¸ì œë¥¼ ë³µìŠµí•˜ì„¸ìš”.'; }
  else if (score >= 60) { grade = 'ğŸ“š ë…¸ë ¥ í•„ìš”'; msg = 'ë” ë§ì€ ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤. í™”ì´íŒ…!'; }
  else { grade = 'âš ï¸ ì¬ë„ì „ ê¶Œì¥'; msg = 'ê¸°ì´ˆë¶€í„° ë‹¤ì‹œ ê³µë¶€í•´ ë³´ì„¸ìš”.'; }
  
  document.getElementById('score-grade').textContent = grade;
  document.getElementById('score-msg').textContent = msg;
  
  // Wrong answers
  const wrongs = state.answers.filter(a => !a.correct);
  const wrongContainer = document.getElementById('wrong-items');
  wrongContainer.innerHTML = '';
  
  if (wrongs.length === 0) {
    document.getElementById('wrong-list').innerHTML = '<div class="divider"></div><div class="text-center" style="color:var(--success);font-size:1.2rem;font-weight:700">ğŸ‰ ëª¨ë‘ ì •ë‹µ! ì™„ë²½í•©ë‹ˆë‹¤!</div>';
  } else {
    const nums = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'];
    wrongs.forEach(a => {
      const q = a.question;
      const div = document.createElement('div');
      div.className = 'wrong-item';
      const myAnswerBadge = a.timeout
        ? `<span class="answer-badge my-answer">â° ì‹œê°„ ì´ˆê³¼</span>`
        : `<span class="answer-badge my-answer">ë‚´ ë‹µ: ${nums[a.selected]} ${q.options[a.selected]}</span>`;
      div.innerHTML = `
        <div class="wrong-item-num">ë¬¸ì œ ID: ${q.id}</div>
        <div class="wrong-item-q">${q.question}</div>
        <div class="wrong-answer-row">
          ${myAnswerBadge}
          <span class="answer-badge correct-answer">ì •ë‹µ: ${nums[q.answer]} ${q.options[q.answer]}</span>
        </div>
        <div class="wrong-explain">ğŸ’¡ ${q.explanation}</div>
        <div class="wrong-explain" style="margin-top:4px">ğŸ“– ${q.source}</div>
      `;
      wrongContainer.appendChild(div);
    });
  }
  
  showScreen('results');
}

// ============ RANKING ============
function loadRankings() {
  const rankings = getRankings();
  const tbody = document.getElementById('ranking-tbody');
  tbody.innerHTML = '';
  
  if (rankings.length === 0) {
    document.getElementById('no-ranking').style.display = 'block';
    return;
  }
  document.getElementById('no-ranking').style.display = 'none';
  
  rankings.slice(0, 50).forEach((r, i) => {
    const rank = i + 1;
    const isMe = state.currentUser && r.userId === state.currentUser.id;
    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
    const tr = document.createElement('tr');
    if (isMe) tr.className = 'my-row';
    tr.innerHTML = `
      <td><span class="rank-badge ${rankClass}">${rank}</span></td>
      <td>${r.nickname}${isMe ? ' <small style="color:var(--accent)">(ë‚˜)</small>' : ''}</td>
      <td><strong style="color:var(--accent);font-family:'Space Mono',monospace">${r.score}</strong>ì </td>
      <td>${r.correct}/${r.total} (${Math.round(r.correct/r.total*100)}%)</td>
      <td>${r.attempts || 1}íšŒ</td>
    `;
    tbody.appendChild(tr);
  });
}

// ============ ADMIN ============
function switchAdminTab(tab) {
  ['quiz','upload','members'].forEach(t => {
    document.getElementById(`atab-${t}`).classList.remove('active');
    document.getElementById(`admin-${t}`).style.display = 'none';
  });
  document.getElementById(`atab-${tab}`).classList.add('active');
  document.getElementById(`admin-${tab}`).style.display = 'block';
  if (tab === 'members') loadMembersList();
}

function loadAdminQuizList() {
  const questions = getQuizData();
  document.getElementById('admin-q-count').textContent = questions.length;
  const list = document.getElementById('admin-quiz-list');
  list.innerHTML = '';
  
  questions.forEach((q, i) => {
    const div = document.createElement('div');
    div.className = 'quiz-item-admin';
    div.innerHTML = `
      <div class="quiz-item-content">
        <div class="quiz-item-num">ë¬¸ì œ ${q.id}</div>
        <div class="quiz-item-q">${q.question.length > 80 ? q.question.slice(0,80)+'...' : q.question}</div>
      </div>
      <div class="quiz-item-actions">
        <button class="btn btn-secondary btn-sm" onclick="editQuiz(${i})">í¸ì§‘</button>
        <button class="btn btn-danger btn-sm" onclick="deleteQuiz(${i})">ì‚­ì œ</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function openAddQuizModal() {
  state.editingQuizId = null;
  document.getElementById('modal-quiz-title').textContent = 'ë¬¸ì œ ì¶”ê°€';
  document.getElementById('modal-q').value = '';
  document.getElementById('modal-answer').value = 0;
  document.getElementById('modal-explain').value = '';
  document.getElementById('modal-source').value = '';
  for (let i = 0; i < 5; i++) document.getElementById(`opt-${i}`).querySelector('input').value = '';
  document.getElementById('modal-quiz').classList.add('show');
}

function editQuiz(idx) {
  state.editingQuizId = idx;
  const q = getQuizData()[idx];
  document.getElementById('modal-quiz-title').textContent = 'ë¬¸ì œ í¸ì§‘';
  document.getElementById('modal-q').value = q.question;
  document.getElementById('modal-answer').value = q.answer;
  document.getElementById('modal-explain').value = q.explanation;
  document.getElementById('modal-source').value = q.source;
  q.options.forEach((opt, i) => {
    document.getElementById(`opt-${i}`).querySelector('input').value = opt;
  });
  document.getElementById('modal-quiz').classList.add('show');
}

function saveQuiz() {
  const question = document.getElementById('modal-q').value.trim();
  const answer = parseInt(document.getElementById('modal-answer').value);
  const explanation = document.getElementById('modal-explain').value.trim();
  const source = document.getElementById('modal-source').value.trim();
  const options = [];
  for (let i = 0; i < 5; i++) {
    options.push(document.getElementById(`opt-${i}`).querySelector('input').value.trim());
  }
  
  if (!question || options.some(o => !o)) { alert('ë¬¸ì œì™€ ëª¨ë“  ì„ íƒì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (answer < 0 || answer > 4) { alert('ì •ë‹µ ë²ˆí˜¸ëŠ” 0~4 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
  
  const questions = getQuizData();
  const newQ = { id: Date.now(), question, options, answer, explanation, source };
  
  if (state.editingQuizId !== null) {
    newQ.id = questions[state.editingQuizId].id;
    questions[state.editingQuizId] = newQ;
  } else {
    questions.push(newQ);
  }
  
  saveQuizData(questions);
  loadAdminQuizList();
  closeModal('modal-quiz');
}

function deleteQuiz(idx) {
  if (!confirm('ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const questions = getQuizData();
  questions.splice(idx, 1);
  saveQuizData(questions);
  loadAdminQuizList();
}

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    document.getElementById('json-paste').value = ev.target.result;
  };
  reader.readAsText(file);
}

function previewJson() {
  const result = document.getElementById('upload-result');
  try {
    const data = JSON.parse(document.getElementById('json-paste').value);
    result.innerHTML = `<div class="alert alert-success">âœ… ìœ íš¨í•œ JSON: ${data.length}ê°œ ë¬¸ì œ í™•ì¸ë¨</div>`;
  } catch(e) {
    result.innerHTML = `<div class="alert alert-error">âŒ JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

function applyJson() {
  const result = document.getElementById('upload-result');
  try {
    const data = JSON.parse(document.getElementById('json-paste').value);
    if (!Array.isArray(data)) { result.innerHTML = '<div class="alert alert-error">ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>'; return; }
    if (!confirm(`${data.length}ê°œì˜ ë¬¸ì œë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    saveQuizData(data);
    result.innerHTML = `<div class="alert alert-success">âœ… ${data.length}ê°œ ë¬¸ì œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
    loadAdminQuizList();
  } catch(e) {
    result.innerHTML = `<div class="alert alert-error">âŒ JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

function loadMembersList() {
  const users = getUsers();
  const rankings = getRankings();
  const container = document.getElementById('members-list');
  
  const entries = Object.entries(users);
  if (entries.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  container.innerHTML = `
    <table class="ranking-table">
      <thead><tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ê°€ì…ì¼</th><th>ë„ì „íšŸìˆ˜</th><th>ìµœê³ ì ìˆ˜</th><th>ê´€ë¦¬</th></tr></thead>
      <tbody>${entries.map(([id, u]) => {
        const r = rankings.find(r => r.userId === id);
        return `<tr>
          <td><span style="font-family:'Space Mono',monospace;font-size:0.85rem">${id}</span></td>
          <td>${u.nickname}</td>
          <td><span style="font-size:0.8rem;color:var(--text2)">${u.joinDate ? new Date(u.joinDate).toLocaleDateString('ko') : '-'}</span></td>
          <td>${u.attempts || 0}íšŒ</td>
          <td>${r ? r.score + 'ì ' : '-'}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteUser('${id}')">ì‚­ì œ</button></td>
        </tr>`;
      }).join('')}</tbody>
    </table>
  `;
}

function deleteUser(userId) {
  if (!confirm(`'${userId}' íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  const users = getUsers();
  delete users[userId];
  saveUsers(users);
  
  const rankings = getRankings().filter(r => r.userId !== userId);
  saveRankings(rankings);
  loadMembersList();
}

// ============ UTILITIES ============
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function showErr(el, msg) {
  el.textContent = msg;
  el.style.display = 'block';
}

async function simpleHash(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded', () => {
  // Check for stored session (basic persistence)
  updateHeader();
});
</script>
</body>
</html>
